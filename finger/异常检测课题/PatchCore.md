Method
>1.Locally aware patch features
>>è®­ç»ƒå›¾ç‰‡é›†$\mathcal{X}_{N}:\forall x \in\mathcal{X}_{N},y_{x}=0$
>>è®­ç»ƒæµ‹è¯•é›†$\mathcal{X}_{N}:\forall x \in\mathcal{X}_{N},y_{x}\in \{0,1\}$
>>$\phi_{i,j}=\phi_{j}(x_{i})$ä½¿ç”¨é¢„è®­ç»ƒæ¨¡åž‹æå–ç¬¬iä¸ªå›¾çš„ç¬¬jå±‚ç‰¹å¾
>>æ–‡ä¸­ä½¿ç”¨åŒ…å«ä¸­å±‚æˆ–ä¸­é—´ç‰¹å¾è¡¨ç¤ºçš„å†…å­˜åº“ Mï¼Œä»¥åˆ©ç”¨æä¾›çš„è®­ç»ƒä¸Šä¸‹æ–‡ï¼Œæ¯”å¦‚Resnet Layer2 å’Œlayer3æå–å¾—åˆ°çš„ç‰¹å¾
>>æž„å»ºæ¯ä¸ªå—çº§ç‰¹å¾è¡¨ç¤ºæ—¶ï¼Œé€šè¿‡å±€éƒ¨é‚»åŸŸèšåˆæ¥å¢žåŠ æ„Ÿå—é‡Žå¤§å°å¹¶æé«˜å¯¹å°ç©ºé—´å˜åŒ–çš„é²æ£’æ€§ï¼ŒåŒæ—¶ä¸æŸå¤±ç©ºé—´åˆ†è¾¨çŽ‡æˆ–ç‰¹å¾å›¾çš„å¯ç”¨æ€§

>2.Coreset-reduced patch-feature memory bank
>>æŽ¥ä½¿ç”¨æ‰€æœ‰å—çº§ç‰¹å¾å¯èƒ½ä¼šå¯¼è‡´è®°å¿†åº“è¿‡å¤§ï¼Œä»Žè€Œå¢žåŠ å­˜å‚¨éœ€æ±‚å’ŒæŽ¨ç†æ—¶é—´ï¼Œå› æ­¤éœ€è¦å¯¹è®°å¿†åº“è¿›è¡Œç¼©å‡ã€‚æ ¸å¿ƒé›†ç¼©å‡æ˜¯ä¸€ç§å‡å°‘æ•°æ®é›†å¤§å°è€Œä¸æ˜¾è‘—æŸå¤±ä¿¡æ¯çš„æŠ€æœ¯ã€‚
>>æ ¸å¿ƒé›†æ˜¯ä»ŽåŽŸå§‹æ•°æ®é›†ä¸­é€‰å–çš„ä»£è¡¨æ€§å­é›†ï¼Œå®ƒå¯ä»¥è¿‘ä¼¼åœ°è¡¨ç¤ºæ•´ä¸ªæ•°æ®é›†çš„ç»“æž„ã€‚åœ¨ PatchCore ä¸­ï¼Œé€šè¿‡æ ¸å¿ƒé›†é€‰æ‹©ç®—æ³•ä»Žå—çº§ç‰¹å¾ä¸­é€‰å–æœ€å…·ä»£è¡¨æ€§çš„ç‰¹å¾å­é›†ã€‚
>>æ–‡ä¸­å®ƒç»“åˆäº†è¿­ä»£è´ªå©ªè¿‘ä¼¼ï¼ˆiterative greedy approximationï¼‰å’Œ Johnson-Lindenstrauss å®šç†æ¥å‡å°‘è®¡ç®—å’Œå­˜å‚¨æˆæœ¬
>
>3.Anomaly Detection with PatchCore
>>å¯¹äºŽå›¾åƒçº§å¼‚å¸¸å¾—åˆ†çš„è®¡ç®—
>>>ç»™å®šç‰¹å¾è®°å¿†åº“ Mï¼Œå¯¹äºŽæµ‹è¯•å›¾åƒ $x^{test}$ï¼Œé¦–å…ˆåŒæ ·ä½¿ç”¨é¢„è®­ç»ƒç½‘ç»œ Ï• æå–å…¶pacth featureï¼Œå¾—åˆ°ä¸€ä¸ªpatch ç‰¹å¾é›†åˆ$P(x_{test})$,å¯¹äºŽå…¶ä¸­çš„æ¯ä¸€ä¸ªç‰¹å¾$m_{test}$ï¼Œåœ¨Mä¸­æ‰¾åˆ°è·ç¦»å…¶æœ€è¿‘çš„ç‰¹å¾$m^{*}$ï¼Œè®¡ç®—å®ƒä»¬çš„è·ç¦»ï¼Œå›¾åƒçº§å¼‚å¸¸å¾—åˆ†åˆ™æ˜¯è¿™äº›è·ç¦»çš„æœ€å¤§å€¼ï¼Œæ•°å­¦è¡¨ç¤ºä¸ºï¼š
>>>ð‘štest,âˆ—,ð‘šâˆ—=argâ¡maxâ¡ð‘štestâˆˆð‘ƒ(ð‘¥test)(argâ¡minâ¡ð‘šâˆˆð‘€âˆ¥ð‘štestâˆ’ð‘šâˆ¥2)mtest,âˆ—â€‹,mâˆ—=argmaxmtestâ€‹âˆˆP(xtestâ€‹)â€‹(argminmâˆˆMâ€‹âˆ¥mtestâ€‹âˆ’mâˆ¥2) ð‘ âˆ—=âˆ¥ð‘štest,âˆ—âˆ’ð‘šâˆ—âˆ¥2sâˆ—=âˆ¥mtest,âˆ—â€‹âˆ’mâˆ—âˆ¥2
$$
m^{test,*},m^{*}=
\underset{m^{test}\in \mathcal{P}(x^{test})}{\text{argmax}}\underset{m\in \mathcal{M}}{\text{argmax}}||m^{test}-m||_{2}
$$
$$
s^{*}=||m^{test,*}-m^{*}||_{2}
$$


>>ç”±äºŽè®¡ç®—å›¾åƒå¼‚å¸¸å¾—åˆ†çš„è¿‡ç¨‹ä¸­éœ€è¦è®¡ç®—æ¯ä¸€ä¸ªæµ‹è¯•patchçš„æœ€è¿‘é‚»è·ç¦»ï¼Œå› æ­¤å¼‚å¸¸åˆ†å‰²å›¾ä¹Ÿå¯ä»¥åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¾—åˆ°ï¼ŒåŒæ—¶ä¸ºäº†å°†pacthçš„å¤§å°åŒ¹é…è¾“å…¥å›¾çš„å¤§å°ï¼Œä½¿ç”¨åŒçº¿æ€§æ’å€¼è¿›è¡Œä¸Šé‡‡æ ·ï¼ŒåŒæ—¶ä½¿ç”¨é«˜æ–¯æ ¸è¿›è¡Œå¹³æ»‘

Code
>1.åœ¨è®­ç»ƒé˜¶æ®µï¼Œéœ€è¦å®Œæˆç‰¹å¾è®°å¿†åº“çš„æž„å»ºï¼Œæ ¸å¿ƒå‡½æ•°ä¸º_fill_memory_bank()è¿™ä¸ªå‡½æ•°çš„æµç¨‹ä¸º:
>>å¯¹äºŽæ¯ä¸ªbatchçš„å›¾åƒæ•°æ®ï¼Œé¦–å…ˆéœ€è¦ä½¿ç”¨_embed()å‡½æ•°æå–å…¶ä¸­çš„ç‰¹å¾ï¼Œ\_embedå‡½æ•°å¯¹åº”ç€ä¸Šè¿°Method ä¸­çš„1.Locally aware patch featuresã€‚\_embedçš„ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š
>>>å‡è®¾è¾“å…¥æ•°æ®çš„ç»´åº¦ä¸ºtorch.Size([2, 3, 224, 224])ï¼Œ2ä¸ºbatchsizeï¼Œå‰©ä¸‹çš„ä¸‰ä¸ªç»´åº¦è¡¨ç¤ºå›¾åƒçš„å½¢çŠ¶ï¼Œé¦–å…ˆä½¿ç”¨"feature_aggregator"è¿›è¡Œç‰¹å¾æå–ï¼Œè¿™é‡Œçš„feature_aggregatoræ˜¯wide_resnet50_2ä¸Žè®­ç»ƒæ¨¡åž‹ï¼Œç»è¿‡è¿™ä¸ªæ¨¡åž‹çš„å¤„ç†åŽå¾—åˆ°featuresæ˜¯ä¸€ä¸ªå­—å…¸ï¼ŒåŒ…å«ä¸¤ä¸ªé”®å€¼å¯¹ï¼Œå¯¹åº”ä¸¤ä¸ªå±‚æ¬¡çš„ç‰¹å¾ï¼Œå…¶ä¸­
>>>>features[layer2]çš„shapeä¸ºtorch.Size([2, 512, 28, 28])
>>>>features[layer3]çš„shapeä¸ºtorch.Size([2, 1024, 14, 14])
>>
>>>ç„¶åŽæå–è¿™ä¸¤ä¸ªå±‚çš„ç‰¹å¾å¾—åˆ°ä¸€ä¸ªé•¿åº¦ä¸º2çš„listï¼Œå…¶ä¸­ï¼š
>>>>features[0].shape = torch.Size([2, 512, 28, 28])
>>>>features[1].shape = torch.Size([2, 1024, 14, 14])

>>>ç„¶åŽå¯¹å¾—åˆ°çš„featuresè¿›è¡Œpactifyæ“ä½œï¼Œå¾—åˆ°çš„æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º2çš„listï¼Œ
>>>>features\[0\].shape=torch.Size([2, 784, 512, 3, 3])
>>>>features\[1\].shape=torch.Size([2, 196, 1024, 3, 3])

>>>ç”±äºŽfeatures[0]å’Œfeatures[1]å¤§å°ä¸ä¸€è‡´ï¼Œå› æ­¤æŽ¥ä¸‹æ¥å¯¹features[1]è¿›è¡Œä¸€äº›å¤„ç†ä½¿å¾—äºŒè€…èƒ½å¤Ÿå¯¹é½ï¼Œå¯¹äºŽfeatures[1]è¿›è¡ŒåŒçº¿æ€§é‡é‡‡æ ·ï¼Œä½¿å¾—å®ƒçš„ç¬¬äºŒä¸ªç»´åº¦196å¯¹é½784
>>
>>>ç„¶åŽè¿›å…¥preprocessingè¿›è¡Œå¤„ç†ï¼Œè¿™ä¸€æ­¥ä¸»è¦è¿›è¡Œè‡ªé€‚åº”å¹³å‡æ± åŒ–å¾—åˆ°çš„featuresçš„shapeä¸º
>>>>features.shape = torch.Size([1568,2, 1024])

>>>æœ€åŽå†è¿›è¡Œpreadapt_aggregator,å¾—åˆ°çš„featuresçš„shapeä¸º
>>>>features.shape = torch.Size([1568, 1024])
>>å¯¹äºŽæ¯ä¸ªå›¾åƒå¾—åˆ°çš„ç‰¹å¾ä¿å­˜åœ¨features listä¸­ï¼Œåˆ©ç”¨GreedyCoresetSamplerè¿›è¡Œæ ¸å¿ƒè‡ªå·±é‡‡æ ·ï¼Œå†ä½¿ç”¨anomaly_scorerä¸­çš„fitæ–¹æ³•æž„å»ºç‰¹å¾è®°å¿†åº“Mï¼Œæž„å»ºçš„æ–¹å¼æ˜¯ä½¿ç”¨faiss.GpuIndexFlatL2()æ–¹æ³•

>2.åœ¨predicté˜¶æ®µ,å¯¹äºŽè¾“å…¥çš„ä¸€ä¸ªbatsize=2çš„æ•°æ®ï¼ŒåŒæ ·å…ˆä½¿ç”¨_embedæ–¹æ³•å¾—åˆ°å¤§å°ä¸º[1568, 1024]çš„ç‰¹å¾ï¼Œç„¶åŽåˆ©ç”¨image_scoresä¸­çš„predictæ–¹æ³•å¾—åˆ°ä¸€ä¸ªpatch_scoresï¼Œè¿™ä¸ªè¡¨ç¤ºæ¯ä¸€ä¸ªpatchçš„å¼‚å¸¸å¾—åˆ†ï¼Œæœ€åŽåˆ©ç”¨convert_to_segmentationå¾—åˆ°å¼‚å¸¸åˆ’åˆ†å›¾

>>>
>
>
>
>
>
>
>
>
>
